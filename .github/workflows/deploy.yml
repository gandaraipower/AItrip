# EC2 자동 배포 워크플로우
# main 브랜치에 push 시 자동 배포
#
# 필요한 GitHub Secrets:
#   - EC2_HOST: EC2 Elastic IP
#   - EC2_USERNAME: ec2-user 또는 ubuntu
#   - EC2_SSH_KEY: EC2 프라이빗 키 전체 내용
#   - DB_HOST: RDS 엔드포인트
#   - DB_NAME: 데이터베이스 이름
#   - DB_USERNAME: RDS 사용자명
#   - DB_PASSWORD: RDS 비밀번호
#   - JWT_SECRET: JWT 서명 키
#   - OPENAI_API_KEY: OpenAI API 키 (선택)

name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/aitrip

            # 최신 코드 가져오기
            git pull origin main

            # .env 파일 생성
            cat << EOF > .env
            DB_HOST=${{ secrets.DB_HOST }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            EOF

            # 재빌드 및 재시작
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build

            # 이전 이미지 정리
            docker image prune -f

            # 배포 완료 확인
            echo "Deployment completed at $(date)"
            docker-compose -f docker-compose.prod.yml ps
